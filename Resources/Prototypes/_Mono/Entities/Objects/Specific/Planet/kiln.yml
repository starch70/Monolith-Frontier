# SPDX-FileCopyrightText: 2025 starch
#
# SPDX-License-Identifier: AGPL-3.0-or-later

- type: entity
  id: Forge
  parent: BaseStructure
  name: forge
  description: A primitive method of refining ores. Barely hot enough to make steel.
  components:
  - type: Sprite
    noRot: true
    sprite: _Mono/Structures/Machines/forge.rsi
    layers:
    - state: icon
    - state: inserting
    scale: 1.25, 1.25
    offset: 0.03, 0.02 # 0625
  - type: PointLight
    radius: 1.75
    energy: 5
    color: "#FFB700"
  - type: Damageable
    damageContainer: StructuralInorganic
    damageModifierSet: Wood
  - type: Fixtures
    fixtures:
      fix1:
        shape:
          !type:PhysShapeAabb
          bounds: "-0.3,-0.3,0.3,0.3"
        density: 60
        mask:
        - MachineMask
        layer:
        - MidImpassable
        - LowImpassable
  - type: ActivatableUI
    key: enum.LatheUiKey.Key
  - type: UserInterface
    interfaces:
      enum.LatheUiKey.Key:
        type: LatheBoundUserInterface
      enum.ResearchClientUiKey.Key:
        type: ResearchClientBoundUserInterface
  - type: Destructible
    thresholds:
    - trigger:
        !type:DamageTrigger
        damage: 50
      behaviors:
      - !type:DoActsBehavior
        acts: [ "Destruction" ]
  - type: AmbientSound
    volume: -5
    range: 5
    sound:
      path: /Audio/Ambience/Objects/fireplace.ogg
  - type: MaterialStorage
    ignoreColor: true
    whitelist:
      tags:
      - Ore
  - type: LatheHeatProducing
  - type: Lathe
    materialUseMultiplier: 1
    timeMultiplier: 1.5
    idleState: icon
    runningState: inserting
    defaultProductionAmount: 10
    productValueModifier: null
    staticPacks:
    - OreSmeltingKiln
  - type: PlaceableSurface
    isPlaceable: false
  - type: Construction
    graph: ForgeGraph
    node: ForgeNode

- type: construction
  id: Forge
  name: forge
  description: Primitive method for refining ore.
  graph: ForgeGraph
  startNode: start
  targetNode: ForgeNode
  category: construction-category-furniture
  icon:
    sprite: _Mono/Structures/Machines/forge.rsi
    state: icon
  objectType: Structure
  placementMode: SnapgridCenter
  canBuildInImpassable: false
  conditions:
  - !type:TileNotBlocked

- type: constructionGraph
  id: ForgeGraph
  start: start
  graph:
  - node: start
    actions:
    - !type:DestroyEntity {}
    edges:
    - to: ForgeNode
      completed:
      - !type:SnapToGrid { }
      steps:
      - material: WoodPlank
        amount: 10
        doAfter: 1
      - tag: RockMaterial
        name: a rock
        icon:
          sprite: _Mono/Objects/Misc/desert_stone.rsi
          state: icon
      - tag: RockMaterial
        name: a rock
        icon:
          sprite: _Mono/Objects/Misc/desert_stone.rsi
          state: icon
        doAfter: 4
      - tag: RockMaterial
        name: a rock
        icon:
          sprite: _Mono/Objects/Misc/desert_stone.rsi
          state: icon
        doAfter: 4

  - node: ForgeNode
    entity: Forge
    edges:
    - to: start
      completed:
      - !type:GivePrototype
        prototype: MaterialWoodPlank1
        amount: 4
      - !type:GivePrototype
        prototype: DesertStone
        amount: 3
      steps:
      - tool: Prying
        doAfter: 1
